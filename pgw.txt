1. Pushgateway lÃ  gÃ¬?

Pushgateway lÃ  má»™t thÃ nh pháº§n trong há»‡ sinh thÃ¡i Prometheus cho phÃ©p push (Ä‘áº©y) metrics tá»« cÃ¡c á»©ng dá»¥ng hoáº·c batch job vÃ o, sau Ä‘Ã³ Pushgateway sáº½ expose metrics ra á»Ÿ endpoint HTTP /metrics Ä‘á»ƒ Prometheus cÃ³ thá»ƒ scrape.

ThÃ´ng thÆ°á»ng Prometheus sá»­ dá»¥ng mÃ´ hÃ¬nh pull (Prometheus chá»§ Ä‘á»™ng scrape metrics tá»« target), nhÆ°ng vá»›i cÃ¡c short-lived jobs (cháº¡y nhanh, káº¿t thÃºc sá»›m nhÆ° cronjob, script ETL, CI/CD pipeline), Prometheus cÃ³ thá»ƒ khÃ´ng ká»‹p scrape â†’ lÃºc nÃ y cáº§n Pushgateway lÃ m trung gian lÆ°u láº¡i metrics.

2. Khi nÃ o sá»­ dá»¥ng Pushgateway?

âœ… NÃªn dÃ¹ng trong cÃ¡c trÆ°á»ng há»£p:

Batch job ngáº¯n háº¡n (cronjob, ETL, script build/test trong CI/CD) cáº§n ghi nháº­n metrics sau khi cháº¡y.

á»¨ng dá»¥ng khÃ´ng thá»ƒ má»Ÿ cá»•ng HTTP Ä‘á»ƒ Prometheus scrape trá»±c tiáº¿p.

Khi muá»‘n gom metrics tá»« nhiá»u job vá» má»™t nÆ¡i táº¡m thá»i trÆ°á»›c khi Prometheus láº¥y.

âŒ KhÃ´ng nÃªn dÃ¹ng cho:

Metrics cá»§a service cháº¡y dÃ i háº¡n (web server, API, database) â†’ nÃªn expose endpoint /metrics trá»±c tiáº¿p.

Metrics yÃªu cáº§u real-time high-frequency vÃ¬ Pushgateway khÃ´ng tá»‘i Æ°u cho luá»“ng lá»›n liÃªn tá»¥c.

3. CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng

á»¨ng dá»¥ng/batch job gá»­i metrics lÃªn Pushgateway qua HTTP API.

Metrics Ä‘Æ°á»£c gáº¯n label job=<job_name> vÃ  cÃ³ thá»ƒ thÃªm instance, grouping key.

Pushgateway lÆ°u metrics táº¡m trong bá»™ nhá»›.

Prometheus scrape Pushgateway endpoint Ä‘á»ƒ láº¥y metrics.

4. TÃ­ch há»£p Pushgateway

CÃ³ nhiá»u cÃ¡ch push metrics:

4.1. Push trá»±c tiáº¿p báº±ng HTTP (khÃ´ng cáº§n thÆ° viá»‡n)

VÃ­ dá»¥ push báº±ng curl:

echo "my_batch_job_success 1" \
  | curl --data-binary @- http://<pushgateway-host>:9091/metrics/job/my_batch_job


ThÃªm label instance:

echo "my_batch_job_duration_seconds 35" \
  | curl --data-binary @- http://<pushgateway-host>:9091/metrics/job/my_batch_job/instance/instance-1

4.2. TÃ­ch há»£p báº±ng Prometheus Client Libraries

Prometheus cung cáº¥p nhiá»u client library há»— trá»£ push:

Python (prometheus_client)

Go (prometheus/client_golang)

Java (simpleclient_pushgateway)

Node.js (prom-client)

ğŸ“Œ VÃ­ dá»¥ Python:

from prometheus_client import CollectorRegistry, Gauge, push_to_gateway

registry = CollectorRegistry()
g = Gauge('my_batch_job_duration_seconds', 'Duration of batch job', registry=registry)
g.set(35)

push_to_gateway('pushgateway:9091', job='my_batch_job', registry=registry)

5. YÃªu cáº§u & Phá»¥ thuá»™c

KhÃ´ng báº¯t buá»™c pháº£i dÃ¹ng lib cá»§a Pushgateway.
Báº¡n cÃ³ thá»ƒ gá»­i raw metrics qua HTTP (nhÆ° vÃ­ dá»¥ curl).

Náº¿u muá»‘n tÃ­ch há»£p tiá»‡n hÆ¡n trong code (Python, Go, Javaâ€¦), nÃªn dÃ¹ng Prometheus client libraries cÃ³ sáºµn hÃ m push_to_gateway.

6. CÃ¡ch kiá»ƒm tra

Push metrics thÃ nh cÃ´ng â†’ truy cáº­p:

http://<pushgateway-host>:9091/metrics


â†’ tháº¥y metrics vá»«a push.

Äáº£m báº£o Prometheus cÃ³ scrape job cho Pushgateway trong prometheus.yml:

scrape_configs:
  - job_name: 'pushgateway'
    static_configs:
      - targets: ['pushgateway:9091']


Query trÃªn Prometheus hoáº·c Grafana:

my_batch_job_duration_seconds

7. Best Practices

Äáº·t tÃªn job rÃµ rÃ ng: job="data_etl", job="ci_pipeline".

Dá»n dáº¹p metrics cÅ© náº¿u khÃ´ng cáº§n, trÃ¡nh dá»¯ liá»‡u stale (cÃ³ thá»ƒ gá»i DELETE API).

KhÃ´ng push metrics tá»« long-running service.
